{% extends "cti/base.html" %}
{% block content %}
<!-- Begin Page Content -->
<script src="https://d3js.org/d3.v4.js"></script>
<div class="container-fluid">


    <style>
      .links line {
        stroke: #999;
        stroke-opacity: 0.6;
      }

      .nodes circle {
        stroke: #fff;
        stroke-width: 1.5px;
      }

    </style>
    <svg width="960" height="600"></svg>
    <div class="row" id="d3graph">
        <script>
            var svg = d3.select("svg");
            var width = svg.attr("width");
            var height = svg.attr("height");
            color = ["red", "green", "blue", "yellow", "black"]

            var graph = {
                nodes: {{ nodes|safe }},
                links: []
            };

            for(var r of {{ links|safe }}) {
                if(r[1] == 'HAS_SENT') {
                    graph.links.push({ 'source': r[0]['ip_address'], 'target': r[2]['path'] })
                } else if (r[1] == 'HAS_ACCESSED') {
                    graph.links.push({ 'source': r[0]['path'], 'target': r[2]['server_name'] })
                }
            }




            var simulation = d3
                .forceSimulation(graph.nodes)
                .force(
                    "link",
                    d3
                    .forceLink(graph.links)
                    .id(function(d) {
                        return d.name;
                    })
                    .distance(function(d) {
                        return 100;
                    })
                )
                .force("charge", d3.forceManyBody().strength(-70))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .on("tick", ticked);

            var link = svg
                .append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(graph.links)
                .enter()
                .append("line")
                .attr("stroke-width", function(d) {
                    return 3;
                });

            var node = svg
                .append("g")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(graph.nodes)
                .enter()
                .append("circle")
                .attr("r", 15)
                .style("fill", function(d) { return color[d.group]; })
                .call(
                    d3
                    .drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended)
                );

            var label = svg.append("g");

            var tooltip = d3.select("body")
                .append("div")
                .style("position", "absolute")
                .style("visibility", "hidden")
                .style("color", "white")
                .style("padding", "8px")
                .style("background-color", "#626D71")
                .style("border-radius", "6px")
                .style("text-align", "center")
                .style("width", "auto")
                .text("");

            label
                .on("mouseover", function(d){
                    tooltip.html(`${d.name}`);
                    return tooltip.style("visibility", "visible");})
                .on("mousemove", function(){
                    return tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})

            node
                .on("mouseover", function(d){
                    tooltip.html(`${d.name}`);
                    return tooltip.style("visibility", "visible");})
                .on("mousemove", function(){
                    return tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
                .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

            function ticked() {
                link
                .attr("x1", function(d) {
                     return d.source.x;
                })
                .attr("y1", function(d) {
                     return d.source.y;
                })
                .attr("x2", function(d) {
                     return d.target.x;
                })
                .attr("y2", function(d) {
                     return d.target.y;
                });

                node
                .attr("cx", function(d) {
                     return d.x;
                })
                .attr("cy", function(d) {
                     return d.y;
                });
            }

            function dragstarted(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragended(d) {
                if (!d3.event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        </script>
    </div>

    <!-- Content Row -->
    <div class="row">

        <!-- Total IPs Card Example -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total IPs
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{numberOfIPs}}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-map-marker-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total requests Card Example -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Requests
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{numberOfRequests}}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-retweet fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Bad IPs Card Example -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Bad IPs
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">1000</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Bad IPs Card Example -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Number of Files Uploaded
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{numberOfFiles}}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Content Row -->

    <div class="row">

        <!-- Area Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div
                        class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">IPs Overview</h6>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="myAreaChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pie Chart -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div
                        class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Request Sources</h6>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="myPieChart"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        <span class="mr-2">
                            <i class="fas fa-circle text-primary"></i> Source 1
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle text-success"></i> Source 2
                        </span>
                        <span class="mr-2">
                            <i class="fas fa-circle text-info"></i> Source 3
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row">

        <!-- Content Column -->
        <div class="col-lg-6 mb-4">

            <!-- Project Card Example -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">IPs</h6>
                </div>
                <div class="card-body">
                    <h4 class="small font-weight-bold">Server Migration <span
                            class="float-right">23%</span></h4>
                    <div class="progress mb-4">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: 20%"
                             aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <h4 class="small font-weight-bold">Sales Tracking <span
                            class="float-right">41%</span></h4>
                    <div class="progress mb-4">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: 40%"
                             aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <h4 class="small font-weight-bold">Customer Database <span
                            class="float-right">69%</span></h4>
                    <div class="progress mb-4">
                        <div class="progress-bar" role="progressbar" style="width: 60%"
                             aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <h4 class="small font-weight-bold">Payout Details <span
                            class="float-right">83%</span></h4>
                    <div class="progress mb-4">
                        <div class="progress-bar bg-info" role="progressbar" style="width: 80%"
                             aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <h4 class="small font-weight-bold">Account Setup <span
                            class="float-right">Complete!</span></h4>
                    <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 100%"
                             aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>


        </div>

        <div class="col-lg-6 mb-4">

            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Top Countries By Unique IPs</h6>
                </div>
                <div class="card-body">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                        <tr>
                            <th scope="col">Country</th>
                            <th scope="col">Number of IPs</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for country in TopCountriesByIP %}
                        <tr>
                            <th scope="row">{{country.country}}</th>
                            <td>{{country.c}}</td>

                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

</div>
<!-- /.container-fluid -->

</div>
<!-- End of Main Content -->
{% endblock content%}
